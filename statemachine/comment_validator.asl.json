{
  "Comment": "A state machine that requires email confirmation from the commenter and site owner before a comment is published.",
  "StartAt": "Challenge Email",
  "States": {
    "Challenge Email": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
      "TimeoutSeconds": 3600,
      "Parameters": {
        "FunctionName": "${ChallengeEmailFunctionArn}",
        "Payload": {
          "commenter_email.$": "$.commenter_email",
          "comment.$": "$.comment",
          "token.$": "$$.Task.Token"
        }
      },
      "Next": "Check Stock Value"
    },
    "Check Stock Value": {
      "Type": "Task",
      "Resource": "${StockCheckerFunctionArn}",
      "Retry": [
        {
          "ErrorEquals": ["States.TaskFailed"],
          "IntervalSeconds": 15,
          "MaxAttempts": 5,
          "BackoffRate": 1.5
        }
      ],
      "Next": "Buy or Sell?"
    },
    "Buy or Sell?": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.stock_price",
          "NumericLessThanEquals": 50,
          "Next": "Buy Stock"
        }
      ],
      "Default": "Sell Stock"
    },
    "Sell Stock": {
      "Type": "Task",
      "Resource": "${StockSellerFunctionArn}",
      "Retry": [
        {
          "ErrorEquals": ["States.TaskFailed"],
          "IntervalSeconds": 2,
          "MaxAttempts": 3,
          "BackoffRate": 1
        }
      ],
      "Next": "Record Transaction"
    },
    "Buy Stock": {
      "Type": "Task",
      "Resource": "${StockBuyerFunctionArn}",
      "Retry": [
        {
          "ErrorEquals": ["States.TaskFailed"],
          "IntervalSeconds": 2,
          "MaxAttempts": 3,
          "BackoffRate": 1
        }
      ],
      "Next": "Record Transaction"
    },
    "Record Transaction": {
      "Type": "Task",
      "Resource": "${DDBPutItem}",
      "Parameters": {
        "TableName": "${DDBTable}",
        "Item": {
          "Id": {
            "S.$": "$.id"
          },
          "Type": {
            "S.$": "$.type"
          },
          "Price": {
            "N.$": "$.price"
          },
          "Quantity": {
            "N.$": "$.qty"
          },
          "Timestamp": {
            "S.$": "$.timestamp"
          }
        }
      },
      "Retry": [
        {
          "ErrorEquals": ["States.TaskFailed"],
          "IntervalSeconds": 20,
          "MaxAttempts": 5,
          "BackoffRate": 10
        }
      ],
      "End": true
    }
  }
}
